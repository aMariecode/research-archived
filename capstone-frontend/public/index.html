<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Capstone Library Kiosk</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Capstone Library Kiosk</span>
      <div class="d-flex align-items-center">
        <div id="userBadge" class="me-2 text-white small" style="display:none"></div>
        <button id="registerBtn" class="btn btn-outline-light btn-sm me-2">Register</button>
        <button id="loginBtn" class="btn btn-outline-light btn-sm me-2">Login</button>
        <button id="logoutBtn" class="btn btn-outline-light btn-sm" style="display:none">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-3">
    <div class="row">
      <div class="col-12 col-md-2">
        <div class="list-group" id="categoryList">
          <!-- categories rendered here -->
        </div>
      </div>

      <div class="col-12 col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="mb-0">Menu</h4>
          <div class="input-group w-50">
            <input id="searchInput" class="form-control form-control-sm" placeholder="Search menu items...">
            <button id="searchBtn" class="btn btn-primary btn-sm">Search</button>
          </div>
        </div>

        <div id="menuGrid" class="row g-3">
          <!-- menu items rendered here -->
        </div>
      </div>

      
    </div>
  </div>

  <template id="menuCardTpl">
    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card h-100 menu-card">
        <img src="" class="card-img-top item-img" alt="">
        <div class="card-body d-flex flex-column">
          <h6 class="card-title item-name"></h6>
          <p class="card-text item-desc text-muted small"></p>
          <div class="mt-auto d-flex justify-content-between align-items-center">
            <small class="text-muted item-price"></small>
            <button class="btn btn-primary btn-sm add-btn">Details</button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Detail Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalLabel">Project Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="detailModalBody">
          <!-- filled dynamically -->
        </div>
        <div class="modal-footer">
              <button id="viewPdfBtn" type="button" class="btn btn-primary">View PDF</button>
              <button id="downloadPdfBtn" type="button" class="btn btn-success">Download</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
      </div>
    </div>
  </div>

  <script>
    // Sample projects data (batches 2023 and 2024) — used as fallback when backend not available
    let PROJECTS = [
      { id: 'p1', title: 'Smart Campus Navigation', authors: 'A. Santos, B. Cruz', batch: 2023, abstract: 'Indoor navigation app for campus buildings using BLE beacons.', img: 'https://via.placeholder.com/300x180?text=Project+1', pdf: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' },
      { id: 'p2', title: 'Automated Attendance System', authors: 'C. Reyes', batch: 2023, abstract: 'Face-recognition based attendance integrated with QR backups.', img: 'https://via.placeholder.com/300x180?text=Project+2', pdf: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' },
      { id: 'p3', title: 'Capstone Archive Search', authors: 'D. Lee, E. Gomez', batch: 2024, abstract: 'Searchable repository for capstone projects with filters and analytics.', img: 'https://via.placeholder.com/300x180?text=Project+3', pdf: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' },
      { id: 'p4', title: 'Energy Monitoring Dashboard', authors: 'F. Tan', batch: 2024, abstract: 'IoT system for monitoring and visualizing energy consumption.', img: 'https://via.placeholder.com/300x180?text=Project+4', pdf: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' }
    ];

    let currentCategory = 'All';
    const BACKEND = 'http://localhost:4000/api';

    // Google Identity Services handlers (client-side only)
    function handleCredentialResponse(response){
      try{
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        const user = { fullName: payload.name || payload.email, email: payload.email, picture: payload.picture };
        localStorage.setItem('accessToken','google:' + response.credential);
        localStorage.setItem('user', JSON.stringify(user));
        showLoggedIn(user);
        fetchCapstones();
      }catch(e){ console.warn('Google sign-in parse failed', e); }
    }

    function initGoogleButton(containerId){
      if (!window.google || !google.accounts || !google.accounts.id) return;
      google.accounts.id.initialize({ client_id: 'REPLACE_WITH_GOOGLE_CLIENT_ID', callback: handleCredentialResponse, ux_mode: 'popup' });
      const el = document.getElementById(containerId);
      if (el) google.accounts.id.renderButton(el, { theme: 'outline', size: 'large' });
    }

    function renderCategories(){
      const categories = ['All', ...Array.from(new Set(PROJECTS.map(m=>m.batch)))];
      const el = document.getElementById('categoryList');
      el.innerHTML = '';
      categories.forEach(cat => {
        const a = document.createElement('button');
        a.className = 'list-group-item list-group-item-action' + (String(cat)===String(currentCategory)? ' active':'');
        a.textContent = cat;
        a.onclick = ()=>{ currentCategory = cat; renderCategories(); renderMenu(); };
        el.appendChild(a);
      });
    }

    function renderMenu(filter=''){
      const grid = document.getElementById('menuGrid');
      grid.innerHTML = '';
      const tpl = document.getElementById('menuCardTpl');
      const qs = (filter || '').toLowerCase();
      PROJECTS.filter(item => (currentCategory==='All' || String(item.batch)===String(currentCategory)) && (!qs || item.title.toLowerCase().includes(qs) || item.authors.toLowerCase().includes(qs) || item.abstract.toLowerCase().includes(qs)))
        .forEach(item => {
          const node = tpl.content.cloneNode(true);
          node.querySelector('.item-img').src = item.img;
          node.querySelector('.item-img').alt = item.title;
          node.querySelector('.item-name').textContent = item.title;
          node.querySelector('.item-desc').textContent = item.authors + ' — ' + item.abstract;
          node.querySelector('.item-price').textContent = `Batch ${item.batch}`;
          const btn = node.querySelector('.add-btn');
          btn.textContent = 'Details';
          btn.onclick = ()=> showDetails(item);
          node.querySelector('.item-img').onclick = () => showDetails(item);
          grid.appendChild(node);
        });
    }

    function showDetails(project){
      const modalTitle = document.getElementById('detailModalLabel');
      const modalBody = document.getElementById('detailModalBody');
      modalTitle.textContent = project.title;
      modalBody.innerHTML = `
        <p><strong>Authors:</strong> ${project.authors}</p>
        <p><strong>Batch:</strong> ${project.batch}</p>
        <p>${project.abstract}</p>
      `;

      // set View and Download handlers
      const viewBtn = document.getElementById('viewPdfBtn');
      const downloadBtn = document.getElementById('downloadPdfBtn');
      viewBtn.onclick = ()=> { window.open(project.pdf, '_blank'); };
      downloadBtn.onclick = ()=> {
        const a = document.createElement('a');
        a.href = project.pdf;
        a.download = project.title.replace(/\s+/g, '_') + '.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
      };

      // (recent list removed) showDetails no longer adds to a recent viewer section

      const modal = new bootstrap.Modal(document.getElementById('detailModal'));
      modal.show();
    }

    async function performSearch(){
      const q = document.getElementById('searchInput').value.trim();
      if (!q) { renderMenu(); return; }
      const token = localStorage.getItem('accessToken');
      if (token) {
        try {
          const res = await fetch(`${BACKEND}/search?query=${encodeURIComponent(q)}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (res.ok) {
            const body = await res.json().catch(()=>null);
            const items = (body && (body.capstones || body.results || body.data)) || body || [];
            if (Array.isArray(items) && items.length > 0) {
              renderFromArray(items);
              return;
            }
          }
        } catch (err) {
          console.warn('Backend search failed, falling back to client filter', err);
        }
      }
      // fallback to client-side
      renderMenu(q);
    }

    function renderFromArray(arr){
      const grid = document.getElementById('menuGrid');
      grid.innerHTML = '';
      const tpl = document.getElementById('menuCardTpl');
      // normalize and set PROJECTS to the fetched array so categories and other views update
      const normalized = arr.map(raw => ({
        id: raw._id || raw.id || raw.capstoneId || raw.name || String(Math.random()),
        title: raw.title || raw.name || raw.fullName || 'Untitled',
        authors: raw.authors || raw.authorsName || raw.owner || 'Unknown',
        batch: raw.batch || raw.year || raw.batchYear || 'N/A',
        abstract: raw.abstract || raw.description || raw.summary || '',
        img: raw.previewImage || raw.image || 'https://via.placeholder.com/300x180?text=Project',
        pdf: raw.pdfUrl || raw.pdf || raw.file || '#'
      }));

      PROJECTS = normalized.length ? normalized : PROJECTS;
      PROJECTS.forEach(item => {
        // normalize fields from backend if necessary
        const node = tpl.content.cloneNode(true);
        node.querySelector('.item-img').src = item.img;
        node.querySelector('.item-img').alt = item.title;
        node.querySelector('.item-name').textContent = item.title;
        node.querySelector('.item-desc').textContent = item.authors + ' — ' + item.abstract;
        node.querySelector('.item-price').textContent = `Batch ${item.batch}`;
        const btn = node.querySelector('.add-btn');
        btn.textContent = 'Details';
        btn.onclick = ()=> showDetails(item);
        node.querySelector('.item-img').onclick = () => showDetails(item);
        grid.appendChild(node);
      });
    }

    document.getElementById('searchBtn').addEventListener('click', performSearch);
    document.getElementById('searchInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter') performSearch(); });

    // auth helpers
    function showLoggedIn(user){
      document.getElementById('userBadge').textContent = `Hi, ${user.fullName || user.email}`;
      document.getElementById('userBadge').style.display = 'block';
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'inline-block';
    }

    function showLoggedOut(){
      document.getElementById('userBadge').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'inline-block';
      document.getElementById('logoutBtn').style.display = 'none';
    }

    async function login(email, password){
      try{
        const res = await fetch(`${BACKEND}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const body = await res.json();
        if (!res.ok) throw new Error(body.message || 'Login failed');
        if (body.accessToken) localStorage.setItem('accessToken', body.accessToken);
        if (body.user) localStorage.setItem('user', JSON.stringify(body.user));
        showLoggedIn(body.user || { fullName: body.user?.fullName || email, email });
        await fetchCapstones();
      }catch(err){
        alert('Login error: ' + (err.message || err));
      }
    }

    async function register(fullName, email, password, school){
      try{
        const res = await fetch(`${BACKEND}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fullName, email, password, school })
        });
        const body = await res.json();
        if (!res.ok) throw new Error(body.message || 'Registration failed');
        if (body.accessToken) localStorage.setItem('accessToken', body.accessToken);
        if (body.user) localStorage.setItem('user', JSON.stringify(body.user));
        showLoggedIn(body.user || { fullName: body.user?.fullName || fullName, email });
        await fetchCapstones();
      }catch(err){
        alert('Registration error: ' + (err.message || err));
      }
    }

    function logout(){
      localStorage.removeItem('accessToken');
      localStorage.removeItem('user');
      showLoggedOut();
      // fallback to local PROJECTS
      renderCategories();
      renderMenu();
    }

    async function fetchCapstones(){
      const token = localStorage.getItem('accessToken');
      if (!token) {
        // remain using local PROJECTS
        renderCategories();
        renderMenu();
        return;
      }
      try{
        const res = await fetch(`${BACKEND}/capstone/all`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to fetch capstones');
        const body = await res.json();
        const arr = Array.isArray(body) ? body : (body.capstones || body.data || body.results || []);
        if (arr.length) renderFromArray(arr);
        else { renderCategories(); renderMenu(); }
      }catch(err){
        console.warn('fetchCapstones failed:', err);
        renderCategories(); renderMenu();
      }
    }

    // wire login UI
    document.getElementById('loginBtn').addEventListener('click', ()=>{
      const modalHtml = `
        <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content auth-modal">
              <div class="modal-header"><h5 class="modal-title">Login</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
              <div class="modal-body">
                <div class="mb-2"><input id="loginEmailInput" class="form-control" placeholder="Email"></div>
                <div class="mb-2"><input id="loginPasswordInput" type="password" class="form-control" placeholder="Password"></div>
                <div class="my-3 text-center">
                  <div id="g_id_on_index" class="d-flex justify-content-center"></div>
                  <div class="small mt-2 text-muted">Or sign in with your Gmail account</div>
                </div>
              </div>
              <div class="modal-footer"><button id="doLoginBtn" class="btn btn-primary">Login</button><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button></div>
            </div>
          </div>
        </div>`;
      const wrapper = document.createElement('div'); wrapper.innerHTML = modalHtml; document.body.appendChild(wrapper);
      const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      loginModal.show();
      // try to render Google button into the modal
      setTimeout(()=>initGoogleButton('g_id_on_index'), 300);
      document.getElementById('doLoginBtn').addEventListener('click', async ()=>{
        const email = document.getElementById('loginEmailInput').value;
        const password = document.getElementById('loginPasswordInput').value;
        await login(email, password);
        loginModal.hide();
        document.getElementById('loginModal').remove();
      });
    });
    // wire register UI
    document.getElementById('registerBtn').addEventListener('click', ()=>{
      const modalHtml = `
        <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content auth-modal">
              <div class="modal-header"><h5 class="modal-title">Register</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
              <div class="modal-body">
                        <div class="mb-2"><input id="regNameInput" class="form-control" placeholder="Full name"></div>
                        <div class="mb-2"><input id="regEmailInput" class="form-control" placeholder="Email"></div>
                        <div class="mb-2"><input id="regSchoolInput" class="form-control" placeholder="Name of School"></div>
                        <div class="mb-2"><input id="regPasswordInput" type="password" class="form-control" placeholder="Password"></div>
                      </div>
                      <div class="modal-footer"><button id="doRegisterBtn" class="btn btn-primary">Register</button><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button></div>
            </div>
          </div>
        </div>`;
      const wrapper = document.createElement('div'); wrapper.innerHTML = modalHtml; document.body.appendChild(wrapper);
      const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
      registerModal.show();
      document.getElementById('doRegisterBtn').addEventListener('click', async ()=>{
        const name = document.getElementById('regNameInput').value;
        const email = document.getElementById('regEmailInput').value;
        const school = document.getElementById('regSchoolInput').value;
        const password = document.getElementById('regPasswordInput').value;
        await register(name, email, password, school);
        registerModal.hide();
        document.getElementById('registerModal').remove();
      });
    });
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // init state
    const savedUser = localStorage.getItem('user');
    if (savedUser) showLoggedIn(JSON.parse(savedUser)); else showLoggedOut();
    // initial data load
    fetchCapstones();
  </script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>