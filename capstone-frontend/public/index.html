<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>UA Research Archive â€” Capstone Library</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
  <!-- Navigation -->
  <nav class="main-nav">
    <div class="nav-container">
      <a href="/" class="nav-brand">
        <img src="ua-seal.png" alt="University of the Assumption" class="nav-brand-icon">
        <div class="nav-brand-text">
          <h1>University of the Assumption</h1>
          <span>Student Capstones Projects</span>
        </div>
      </a>
      
      <ul class="nav-menu">
        <li><a href="/index.html" class="active"><i class="bi bi-house"></i> Home</a></li>
        <li><a href="#projects"><i class="bi bi-collection"></i> Projects</a></li>
      </ul>
      
      <div class="nav-actions">
        <div id="guestActions">
          <a href="/login.html" class="btn btn-outline-light btn-sm">Sign In</a>
        </div>
        <div id="userActions" style="display:none">
          <div class="nav-user">
            <span id="userName">User</span>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-chevron-down"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li id="adminLink" style="display:none"><a class="dropdown-item" href="/admin.html"><i class="bi bi-speedometer2"></i> Admin Dashboard</a></li>
                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-content">
      <h1><i class="bi bi-mortarboard"></i> Explore Student Research</h1>
      <p>Discover innovative capstone projects from the Bachelor of Information Technology program at the University of the Assumption</p>
      
      <div class="hero-search">
        <input type="text" id="searchInput" placeholder="Search projects by title, author, or keyword...">
        <button class="btn btn-primary" onclick="searchProjects()">
          <i class="bi bi-search"></i> Search
        </button>
      </div>
      
      <div class="hero-stats">
        <div class="hero-stat">
          <div class="hero-stat-value" id="statProjects">0</div>
          <div class="hero-stat-label">Projects</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-value" id="statYears">0</div>
          <div class="hero-stat-label">Batch Years</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-value" id="statAuthors">0</div>
          <div class="hero-stat-label">Authors</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filter Section -->
  <section class="filter-section">
    <div class="filter-container">
      <div class="filter-tabs" id="yearTabs">
        <button class="filter-tab active" data-year="all">All Years</button>
        <!-- Year tabs will be dynamically added -->
      </div>
      
      <div class="filter-options">
        <select class="filter-select" id="sortSelect" onchange="sortProjects()">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="title">Title A-Z</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Projects Section -->
  <section class="projects-section" id="projects">
    <div class="projects-header">
      <h2><i class="bi bi-grid-3x3-gap"></i> Capstone Projects</h2>
      <span class="projects-count" id="projectsCount">Loading...</span>
    </div>
    
    <div class="projects-grid" id="projectsGrid">
      <!-- Project cards will be dynamically added -->
    </div>
    
    <div class="empty-state" id="emptyState" style="display:none">
      <div class="empty-state-icon"><i class="bi bi-inbox"></i></div>
      <h3>No projects found</h3>
      <p>Try adjusting your search or filter criteria</p>
    </div>
  </section>

  <!-- Footer -->
  <footer class="main-footer" id="about">
    <div class="footer-content">
      <div class="footer-section">
        <h4>UA Research Archive</h4>
        <p>A digital repository for capstone projects from the Bachelor of Information Technology program at the University of the Assumption.</p>
      </div>
      <div class="footer-section">
        <h4>Quick Links</h4>
        <a href="/index.html">Home</a>
        <a href="#projects">Browse Projects</a>
        <a href="/login.html">Sign In</a>
      </div>
      <div class="footer-section">
        <h4>Contact</h4>
        <p>University of the Assumption<br>City of San Fernando, Pampanga</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2026 UA Research Archive. Bachelor of Information Technology.</p>
    </div>
  </footer>

  <!-- Project Detail Modal -->
  <div class="modal fade" id="projectModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Project Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Content will be dynamically added -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-primary" id="viewPdfBtn">
            <i class="bi bi-eye"></i> View PDF
          </button>
          <button type="button" class="btn btn-success" id="downloadPdfBtn">
            <i class="bi bi-download"></i> Download
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const BACKEND = `https://research-archived.onrender.com/api`;
    let allProjects = [];
    let filteredProjects = [];
    let currentYear = 'all';
    let currentProject = null;

    // Check auth status
    function checkAuth() {
      const token = localStorage.getItem('accessToken');
      const user = localStorage.getItem('user');
      
      if (token && token !== 'undefined' && token !== 'null' && user) {
        try {
          const userData = JSON.parse(user);
          document.getElementById('guestActions').style.display = 'none';
          document.getElementById('userActions').style.display = 'block';
          document.getElementById('userName').textContent = userData.fullName || 'User';
          document.getElementById('userAvatar').textContent = (userData.fullName || 'U').charAt(0).toUpperCase();
          
          if (userData.role === 'Admin') {
            document.getElementById('adminLink').style.display = 'block';
          }
        } catch (e) {}
      } else if (token === 'undefined' || token === 'null') {
        localStorage.removeItem('accessToken');
      }
    }

    function logout() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    // Fetch projects from backend
    async function fetchProjects() {
      try {
        const res = await fetch(`${BACKEND}/capstone/approved`);
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        allProjects = data.data || [];
        filteredProjects = [...allProjects];
        
        updateStats();
        generateYearTabs();
        renderProjects();
      } catch (err) {
        console.error('Error fetching projects:', err);
        document.getElementById('projectsCount').textContent = 'Error loading projects';
      }
    }

    // Update stats
    function updateStats() {
      document.getElementById('statProjects').textContent = allProjects.length;
      
      const years = [...new Set(allProjects.map(p => p.year))];
      document.getElementById('statYears').textContent = years.length;
      
      let authorCount = 0;
      allProjects.forEach(p => {
        authorCount += (p.members || []).length;
      });
      document.getElementById('statAuthors').textContent = authorCount;
    }

    // Generate year filter tabs
    function generateYearTabs() {
      const years = [...new Set(allProjects.map(p => p.year))].sort((a, b) => b - a);
      const tabsContainer = document.getElementById('yearTabs');
      
      // Keep the "All Years" tab
      tabsContainer.innerHTML = '<button class="filter-tab active" data-year="all" onclick="filterByYear(\'all\')">All Years</button>';
      
      years.forEach(year => {
        const tab = document.createElement('button');
        tab.className = 'filter-tab';
        tab.dataset.year = year;
        tab.textContent = year;
        tab.onclick = () => filterByYear(year);
        tabsContainer.appendChild(tab);
      });
    }

    // Filter by year
    function filterByYear(year) {
      currentYear = year;
      
      // Update active tab
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.year == year);
      });
      
      applyFilters();
    }

    // Search projects
    function searchProjects() {
      applyFilters();
    }

    // Sort projects
    function sortProjects() {
      applyFilters();
    }

    // Apply all filters
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const sortBy = document.getElementById('sortSelect').value;
      
      filteredProjects = allProjects.filter(project => {
        // Year filter (from year tabs)
        if (currentYear !== 'all' && project.year != currentYear) return false;
        
        // Search filter
        if (searchTerm) {
          const title = (project.title || '').toLowerCase();
          const abstract = (project.abstract || '').toLowerCase();
          const authors = (project.members || []).join(' ').toLowerCase();
          const adviser = (project.adviser || '').toLowerCase();
          const technologies = (project.technologies || []).join(' ').toLowerCase();
          const year = String(project.year || '');
          
          // Check if search term matches any field
          if (!title.includes(searchTerm) && 
              !abstract.includes(searchTerm) && 
              !authors.includes(searchTerm) &&
              !adviser.includes(searchTerm) &&
              !technologies.includes(searchTerm) &&
              !year.includes(searchTerm)) {
            return false;
          }
        }
        
        return true;
      });
      
      // Sort
      filteredProjects.sort((a, b) => {
        switch (sortBy) {
          case 'newest': return (b.year || 0) - (a.year || 0);
          case 'oldest': return (a.year || 0) - (b.year || 0);
          case 'title': return (a.title || '').localeCompare(b.title || '');
          default: return 0;
        }
      });
      
      renderProjects();
    }

    // Render projects
    function renderProjects() {
      const grid = document.getElementById('projectsGrid');
      const emptyState = document.getElementById('emptyState');
      const countEl = document.getElementById('projectsCount');
      
      if (filteredProjects.length === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        countEl.textContent = '0 projects';
        return;
      }
      
      emptyState.style.display = 'none';
      countEl.textContent = `${filteredProjects.length} project${filteredProjects.length !== 1 ? 's' : ''}`;
      
      grid.innerHTML = filteredProjects.map(project => `
        <div class="project-card">
          <div class="project-card-image">
            ${project.previewImage?.url 
              ? `<img src="${project.previewImage.url}" alt="${project.title}">`
              : '<div class="placeholder-icon"><i class="bi bi-file-earmark-text"></i></div>'
            }
            <span class="project-card-year">${project.year || 'N/A'}</span>
          </div>
          <div class="project-card-body">
            <h3 class="project-card-title">${project.title || 'Untitled'}</h3>
            <p class="project-card-authors">
              <i class="bi bi-people"></i>
              ${(project.members || []).join(', ') || 'No authors listed'}
            </p>
            <p class="project-card-abstract">${project.abstract || 'No abstract available'}</p>
            <div class="project-card-footer">
              <button class="btn btn-outline-primary btn-sm" onclick="viewProject('${project._id}')">
                <i class="bi bi-eye"></i> Details
              </button>
              ${project.pdfUrl ? `
                <button class="btn btn-primary btn-sm" onclick="downloadPdf('${project._id}', '${project.title}')">
                  <i class="bi bi-download"></i> PDF
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    // View project details
    function viewProject(id) {
      const project = allProjects.find(p => p._id === id);
      if (!project) return;
      
      currentProject = project;
      
      document.getElementById('modalTitle').textContent = project.title || 'Project Details';
      document.getElementById('modalBody').innerHTML = `
        <div class="row">
          <div class="col-md-5">
            ${project.previewImage?.url 
              ? `<img src="${project.previewImage.url}" class="img-fluid rounded mb-3" alt="${project.title}">`
              : '<div class="bg-light rounded p-5 text-center text-muted mb-3"><i class="bi bi-image" style="font-size: 3rem;"></i></div>'
            }
          </div>
          <div class="col-md-7">
            <h4>${project.title || 'Untitled'}</h4>
            <p class="text-muted mb-2"><i class="bi bi-calendar"></i> Batch ${project.year || 'N/A'}</p>
            <p class="mb-3"><i class="bi bi-people text-accent"></i> <strong>Authors:</strong><br>${(project.members || []).join(', ') || 'Not specified'}</p>
            ${project.adviser ? `<p class="mb-3"><i class="bi bi-person-badge"></i> <strong>Adviser:</strong> ${project.adviser}</p>` : ''}
          </div>
        </div>
        <hr>
        <h5>Abstract</h5>
        <p>${project.abstract || 'No abstract available'}</p>
      `;
      
      // Setup PDF buttons - use backend proxy for proper PDF headers
      const viewBtn = document.getElementById('viewPdfBtn');
      const downloadBtn = document.getElementById('downloadPdfBtn');
      
      if (project.pdfUrl) {
        viewBtn.style.display = 'inline-flex';
        downloadBtn.style.display = 'inline-flex';
        // Use backend endpoint that sets proper Content-Type and Content-Disposition
        viewBtn.onclick = () => window.open(`${BACKEND}/capstone/${project._id}/pdf`, '_blank');
        downloadBtn.onclick = () => downloadPdf(project._id, project.title);
      } else {
        viewBtn.style.display = 'none';
        downloadBtn.style.display = 'none';
      }
      
      // Track view analytics
      trackView(id);
      
      new bootstrap.Modal(document.getElementById('projectModal')).show();
    }

    // Download PDF using backend proxy endpoint
    function downloadPdf(capstoneId, title) {
      // Clean title for filename
      const cleanTitle = (title || 'capstone').replace(/[^a-zA-Z0-9_-]/g, '_');
      const filename = `${cleanTitle}.pdf`;
      
      // Use backend endpoint with download=1 parameter for attachment disposition
      const downloadUrl = `${BACKEND}/capstone/${capstoneId}/pdf?download=1`;
      
      // Create a temporary link to trigger download
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Track download
      if (currentProject) {
        trackDownload(currentProject._id);
      }
    }

    // Track view analytics
    async function trackView(id) {
      try {
        const token = localStorage.getItem('accessToken');
        if (token) {
          await fetch(`${BACKEND}/capstone/analytics/view/${id}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });
        }
      } catch (e) {}
    }

    // Track download analytics
    async function trackDownload(id) {
      try {
        const token = localStorage.getItem('accessToken');
        if (token) {
          await fetch(`${BACKEND}/capstone/analytics/download/${id}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });
        }
      } catch (e) {}
    }

    // Search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchProjects();
    });

    // Initialize
    checkAuth();
    fetchProjects();
  </script>
</body>
</html>